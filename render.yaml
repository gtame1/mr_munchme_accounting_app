# Render deployment configuration
# https://render.com/docs/render-yaml-reference
#
# This app uses two separate PostgreSQL databases (one per domain).
# On Render's free plan only one free database is available — upgrade to
# paid plan or use DATABASE_URL for both repos temporarily during dev.
#
# First-time setup after deploy:
#   1. Deploy succeeds (migrations run automatically via preDeployCommand)
#   2. SSH into the service and run: bin/ledgr seed
#      (or trigger it from the Render shell)

services:
  - type: web
    name: ledgr
    runtime: elixir
    plan: starter        # change to 'free' if testing, 'standard' for production
    region: oregon       # choose region closest to your users

    buildCommand: >
      mix deps.get --only prod &&
      MIX_ENV=prod mix compile &&
      MIX_ENV=prod mix assets.deploy &&
      MIX_ENV=prod mix release

    # Runs BEFORE the new version goes live — safe for migrations.
    preDeployCommand: >
      _build/prod/rel/ledgr/bin/ledgr eval "Ledgr.Release.migrate()"

    startCommand: _build/prod/rel/ledgr/bin/ledgr start

    envVars:
      - key: MIX_ENV
        value: prod

      - key: PHX_SERVER
        value: "true"

      # Your deployed hostname on Render — update after first deploy
      - key: PHX_HOST
        value: ledgr.onrender.com   # ← update this

      - key: SECRET_KEY_BASE
        generateValue: true         # Render generates a secure random value

      - key: POOL_SIZE
        value: "2"

      # Credentials for the admin user created by `bin/ledgr seed`
      # Set these in the Render dashboard (not here) to keep them secret.
      - key: ADMIN_EMAIL
        sync: false                 # set manually in Render dashboard
      - key: ADMIN_PASSWORD
        sync: false                 # set manually in Render dashboard

      # Database URLs — automatically injected from the databases below.
      - key: MR_MUNCH_ME_DATABASE_URL
        fromDatabase:
          name: ledgr-mr-munch-me-db
          property: connectionString

      - key: VIAXE_DATABASE_URL
        fromDatabase:
          name: ledgr-viaxe-db
          property: connectionString

databases:
  - name: ledgr-mr-munch-me-db
    databaseName: ledgr_mr_munch_me_prod
    user: ledgr_mr_munch_me
    plan: starter        # 'free' gives 1 free DB per account; second one requires paid plan

  - name: ledgr-viaxe-db
    databaseName: ledgr_viaxe_prod
    user: ledgr_viaxe
    plan: starter
